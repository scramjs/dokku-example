<link rel="import" href="../../../../node_modules/@polymer/polymer/polymer.html">

<link rel="import" href="../../../../node_modules/express-web-components/express-app.html">
<link rel="import" href="../../../../node_modules/express-web-components/express-middleware.html">
<link rel="import" href="../../../../node_modules/express-web-components/express-config.html">
<link rel="import" href="../../../../node_modules/express-web-components/express-router.html">

<dom-module id="server-app">
    <template>
        <express-app port="5000">
            <express-config callback="[[staticMW]]"></express-config>
            <express-middleware method="get" path="/" callback="[[indexHandler]]"></express-middleware>
            <express-router path="/api">
                <express-middleware method="get" path="/running-since" callback="[[runningSinceHandler]]"></express-middleware>
                <express-middleware method="get" path="/source-code" callback="[[sourceCodeHandler]]"></express-middleware>
            </express-router>
        </express-app>
    </template>

    <script>
        class AppComponent {
            beforeReady() {
                this.is = 'server-app';
                this.port = process.env.PORT || 5000;
            }

            ready() {
                const path = require('path');

                this.staticMW = (app, express) => {
                    app.use(express.static('app/client'));
                };

                this.indexHandler = (req, res) => {
                    res.sendFile(path.join(__dirname, '/../client/index.html'));
                };

                const runningSince = new Date();
                this.runningSinceHandler = (req, res) => {
                    res.send(runningSince);
                };

                this.sourceCodeHandler = (req, res) => {
                    res.setHeader('Content-Type', 'text/plain');
                    res.send(this.innerHTML);
                };
            }
        }

        Polymer(AppComponent);
    </script>
</dom-module>
